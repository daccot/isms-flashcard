<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISMSãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .dashboard {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none;
        }
        .dashboard h2 { text-align: center; color: #667eea; margin-bottom: 25px; font-size: 1.8rem; }
        .dashboard-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 10px; text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .stat-card h3 { font-size: 0.9rem; margin-bottom: 10px; opacity: 0.9; }
        .stat-card p { font-size: 1.8rem; font-weight: bold; }
        .progress-mini { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-mini-bar { background: white; height: 100%; border-radius: 4px; transition: width 0.3s; width: 0%; }
        .chart-container {
            background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;
            position: relative; height: 300px;
        }
        .chart-container canvas { max-height: 250px; }
        .card {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px;
        }
        h1 { text-align: center; color: #333; margin-bottom: 20px; font-size: 1.8rem; }
        .filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 600; }
        select {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 1rem; transition: border-color 0.3s;
        }
        select:focus { outline: none; border-color: #667eea; }
        .progress { text-align: center; margin-bottom: 20px; color: #666; font-size: 1.1rem; }
        .badges { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .badge-category { background: #e3f2fd; color: #1976d2; }
        .badge-difficulty { background: #fff3e0; color: #f57c00; }
        .badge-type { background: #f3e5f5; color: #7b1fa2; }
        .question {
            font-size: 1.2rem; line-height: 1.8; margin-bottom: 25px; color: #333;
            padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;
        }
        .options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; }
        .option {
            display: flex; align-items: center; padding: 15px; border: 2px solid #ddd;
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
        }
        .option:hover { border-color: #667eea; background: #f8f9fa; }
        .option input[type="checkbox"], .option input[type="radio"] {
            margin-right: 12px; width: 20px; height: 20px; cursor: pointer;
        }
        .option.correct { background: #d4edda; border-color: #28a745; }
        .option.incorrect { background: #f8d7da; border-color: #dc3545; }
        .btn {
            padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .actions { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .result { text-align: center; padding: 20px; border-radius: 10px; margin-top: 20px; font-size: 1.1rem; font-weight: 600; display: none; }
        .result.correct { background: #d4edda; color: #155724; display: block; }
        .result.incorrect { background: #f8d7da; color: #721c24; display: block; }
        .final-result { text-align: center; padding: 30px; display: none; }
        .final-result h2 { color: #667eea; font-size: 2rem; margin-bottom: 20px; }
        .score { font-size: 3rem; font-weight: bold; color: #333; margin: 20px 0; }
        .extra-actions { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        .hidden { display: none !important; }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .card { padding: 20px; }
            h1 { font-size: 1.4rem; }
            .question { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard" id="dashboard">
            <h2>ğŸ“Š å­¦ç¿’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>ğŸ“… ä»Šæ—¥ã®ç›®æ¨™</h3>
                    <p id="todayGoal">5å•ä¸­ 0å•å®Œäº†</p>
                    <div class="progress-mini"><div class="progress-mini-bar" id="todayProgress"></div></div>
                </div>
                <div class="stat-card">
                    <h3>ğŸ”¥ é€£ç¶šå­¦ç¿’</h3>
                    <p id="streakDays">0æ—¥é€£ç¶š</p>
                </div>
                <div class="stat-card">
                    <h3>ğŸ¯ ç·åˆæ­£ç­”ç‡</h3>
                    <p id="overallRate">0%</p>
                </div>
            </div>
            <div class="chart-container"><canvas id="progressChart"></canvas></div>
            <div class="chart-container"><canvas id="categoryChart"></canvas></div>
            <button class="btn btn-primary" id="startQuizBtn">ğŸ“ ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹</button>
        </div>
        
        <div class="card">
            <h1>ğŸ”’ ISMSãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</h1>
            <div class="filters">
                <div class="filter-group">
                    <label for="categoryFilter">ã‚«ãƒ†ã‚´ãƒª:</label>
                    <select id="categoryFilter">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="ISOåŸºç¤">ISOåŸºç¤</option>
                        <option value="ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ">ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ</option>
                        <option value="ãƒªã‚¹ã‚¯ç®¡ç†">ãƒªã‚¹ã‚¯ç®¡ç†</option>
                        <option value="ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ">ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ</option>
                        <option value="è³‡ç”£ç®¡ç†">è³‡ç”£ç®¡ç†</option>
                        <option value="ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡">ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</option>
                        <option value="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</option>
                        <option value="ç‰©ç†çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£">ç‰©ç†çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</option>
                        <option value="ãƒãƒªã‚·ãƒ¼ç­–å®š">ãƒãƒªã‚·ãƒ¼ç­–å®š</option>
                        <option value="å¤‰æ›´ç®¡ç†">å¤‰æ›´ç®¡ç†</option>
                        <option value="æš—å·åŒ–">æš—å·åŒ–</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="difficultyFilter">é›£æ˜“åº¦:</label>
                    <select id="difficultyFilter">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="åˆç´š">åˆç´š</option>
                        <option value="ä¸­ç´š">ä¸­ç´š</option>
                        <option value="ä¸Šç´š">ä¸Šç´š</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="reviewMode">ãƒ¢ãƒ¼ãƒ‰:</label>
                    <select id="reviewMode">
                        <option value="all">å…¨å•é¡Œ</option>
                        <option value="wrong">é–“é•ãˆãŸå•é¡Œã®ã¿</option>
                    </select>
                </div>
            </div>
            <div class="progress">
                <span id="questionNumber">å•é¡Œ 1/14</span> | <span id="score">æ­£è§£: 0/0</span>
            </div>
            <div id="quizContent">
                <div class="badges">
                    <span class="badge badge-category" id="categoryBadge">ã‚«ãƒ†ã‚´ãƒª</span>
                    <span class="badge badge-difficulty" id="difficultyBadge">é›£æ˜“åº¦</span>
                    <span class="badge badge-type" id="typeBadge">æŠä¸€</span>
                </div>
                <div class="question" id="questionText">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div class="options" id="optionsContainer"></div>
                <div class="actions">
                    <button class="btn btn-primary" id="checkBtn">ç­”ãˆåˆã‚ã›</button>
                    <button class="btn btn-secondary hidden" id="nextBtn">æ¬¡ã®å•é¡Œ</button>
                </div>
                <div class="result" id="result"></div>
            </div>
            <div id="finalResult" class="final-result">
                <h2>ğŸ‰ ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
                <div class="score" id="finalScore">0/0</div>
                <div class="extra-actions">
                    <button class="btn btn-small btn-primary" id="retryBtn">ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
                    <button class="btn btn-small btn-secondary" id="dashboardBtn">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    <button class="btn btn-small btn-secondary" id="exportBtn">ğŸ“Š CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-small btn-secondary" id="shareBtn">ğ•ã§å…±æœ‰</button>
                </div>
            </div>
        </div>
    </div>
<script id="mainScript">
// Google Sheets APIè¨­å®š
// â˜…æ³¨æ„: æ­£ã—ã„Webã‚¢ãƒ—ãƒªURLï¼ˆæœ«å°¾ãŒ/execã®ã‚‚ã®ï¼‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ç”»é¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šç›´ã—ã¦ãã ã•ã„
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbz7ru38v7UvLMGMF9BYE6-EwD7T7kP5x_18Ffya90Vc230c8hFNeCWKUF5DevqFctWCDg/exec';

let allQuestions = [];
let filteredQuestions = [];
let currentQuestion = 0;
let correctCount = 0; // â˜…è¿½åŠ : æœªå®šç¾©ã‚¨ãƒ©ãƒ¼å›é¿
let selectedAnswers = {};
let quizStarted = false;

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadQuestions();
    setupEventListeners();
});

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
function setupEventListeners() {
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('difficultyFilter').addEventListener('change', applyFilters);
    document.getElementById('reviewMode').addEventListener('change', applyFilters);
    document.getElementById('checkBtn').addEventListener('click', checkAnswer);
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
    document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
    document.getElementById('retryBtn').addEventListener('click', retryQuiz);
    document.getElementById('dashboardBtn').addEventListener('click', showDashboard);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('shareBtn').addEventListener('click', shareOnX);
}

// Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
async function loadQuestions() {
    try {
        // CORSå¯¾ç­–: ã‚·ãƒ³ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(GET)ã¨ã—ã¦é€ä¿¡
        // â˜…ä¿®æ­£: URLå¤‰æ•°ã®å‚ç…§å…ˆã‚’ä¿®æ­£
        const response = await fetch(GAS_API_URL);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const jsonData = await response.json();
        allQuestions = jsonData;
        
        // åˆæœŸèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        applyFilters();
        
        // èª­ã¿è¾¼ã¿å®Œäº†è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
        console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:", allQuestions.length + "å•");
        
    } catch (e) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        document.getElementById('questionText').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®URLã‚„ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
function applyFilters() {
    const category = document.getElementById('categoryFilter').value;
    const difficulty = document.getElementById('difficultyFilter').value;
    const reviewMode = document.getElementById('reviewMode').value;
    
    if (!allQuestions.length) return; // ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ä½•ã‚‚ã—ãªã„

    filteredQuestions = allQuestions.filter(q => {
        if (category && q.category !== category) return false;
        if (difficulty && q.difficulty !== difficulty) return false;
        // wrongãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆï¼ˆåˆå›ï¼‰ã¯falseæ‰±ã„ã«ã™ã‚‹ãªã©å®‰å…¨ç­–ã‚’è¿½åŠ 
        if (reviewMode === 'wrong' && !q.wrong) return false;
        return true;
    });
    
    // ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    filteredQuestions.sort(() => Math.random() - 0.5);
}

// ã‚¯ã‚¤ã‚ºé–‹å§‹
function startQuiz() {
    if (filteredQuestions.length === 0) {
        alert('è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    quizStarted = true;
    currentQuestion = 0;
    correctCount = 0; // ãƒªã‚»ãƒƒãƒˆ
    selectedAnswers = {};
    
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('quizContent').style.display = 'block';
    document.getElementById('finalResult').style.display = 'none';
    
    showQuestion();
}

// å•é¡Œè¡¨ç¤º
function showQuestion() {
    if (currentQuestion >= filteredQuestions.length) {
        showFinalResult();
        return;
    }
    
    const q = filteredQuestions[currentQuestion];
    document.getElementById('questionNumber').textContent = 
        `å•é¡Œ ${currentQuestion + 1}/${filteredQuestions.length}`;
    document.getElementById('score').textContent = 
        `æ­£è§£: ${correctCount}/${currentQuestion}`;
    
    // å®‰å…¨ç­–: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    document.getElementById('categoryBadge').textContent = q.category || '-';
    document.getElementById('difficultyBadge').textContent = q.difficulty || '-';
    document.getElementById('typeBadge').textContent = q.type || 'æŠä¸€';
    document.getElementById('questionText').textContent = q.question || 'å•é¡Œæ–‡ãŒã‚ã‚Šã¾ã›ã‚“';
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    // optionsãŒé…åˆ—ã§ãªã„å ´åˆã®å¯¾ç­–
    const options = Array.isArray(q.options) ? q.options : [];
    const inputType = q.type === 'è¤‡æ•°é¸æŠ' ? 'checkbox' : 'radio';
    
    options.forEach((option, index) => {
        const div = document.createElement('div');
        div.className = 'option';
        div.innerHTML = `
            <input type="${inputType}" name="option" value="${option}" id="opt${index}">
            <label for="opt${index}" style="margin: 0; cursor: pointer; flex: 1;">${option}</label>
        `;
        // ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        div.addEventListener('click', (e) => {
            if(e.target.tagName !== 'INPUT') {
                const chk = div.querySelector('input');
                if (inputType === 'radio') {
                    chk.checked = true;
                } else {
                    chk.checked = !chk.checked;
                }
            }
        });
        optionsContainer.appendChild(div);
    });
    
    document.getElementById('checkBtn').classList.remove('hidden');
    document.getElementById('nextBtn').classList.add('hidden');
    
    const resultEl = document.getElementById('result');
    resultEl.classList.remove('correct', 'incorrect');
    resultEl.style.display = 'none';
}

// ç­”ãˆåˆã‚ã›
function checkAnswer() {
    const q = filteredQuestions[currentQuestion];
    const inputs = document.querySelectorAll('input[name="option"]');
    // valueã«ã¯optionã®ãƒ†ã‚­ã‚¹ãƒˆãã®ã‚‚ã®ã‚’ä½¿ã†ã‹ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã†ã‹GASã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã‚‹
    // ã“ã“ã§ã¯inputã®valueã«optionãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥ã‚ŒãŸä¿®æ­£ç‰ˆã«åˆã‚ã›ã¦ã„ã¾ã™
    const selected = Array.from(inputs).filter(i => i.checked).map(i => i.value);
    
    if (selected.length === 0) {
        alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
        return;
    }
    
    // æ­£è§£ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼èª¿æ•´ï¼ˆGASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ä¾å­˜ã—ã¾ã™ï¼‰
    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã‹ã€é…åˆ—ã‹ã‚’åˆ¤å®šã—ã¦å‡¦ç†
    let correctAnswers = [];
    if (Array.isArray(q.correct)) {
        correctAnswers = q.correct;
    } else if (typeof q.correct === 'string') {
        correctAnswers = q.correct.split(',').map(s => s.trim());
    } else {
        correctAnswers = [String(q.correct)];
    }
    
    // é…åˆ—ã®ä¸­èº«ã‚’æ¯”è¼ƒï¼ˆé †åºã‚’å•ã‚ãªã„å ´åˆï¼‰
    const isCorrect = selected.length === correctAnswers.length &&
        selected.every(s => correctAnswers.includes(s));
    
    selectedAnswers[q.id] = { selected, correct: correctAnswers, isCorrect };
    
    if (isCorrect) {
        correctCount++;
        q.wrong = false;
        showResultMessage('âœ… æ­£è§£ã§ã™ï¼', true);
    } else {
        q.wrong = true;
        showResultMessage(
            `âŒ ä¸æ­£è§£ã§ã™ã€‚æ­£è§£: ${correctAnswers.join(', ')}`,
            false
        );
    }
    
    document.getElementById('checkBtn').classList.add('hidden');
    document.getElementById('nextBtn').classList.remove('hidden');
    updateHistory();
}

// çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showResultMessage(msg, isCorrect) {
    const result = document.getElementById('result');
    result.textContent = msg;
    result.className = isCorrect ? 'result correct' : 'result incorrect';
    result.style.display = 'block';
}

// æ¬¡ã®å•é¡Œ
function nextQuestion() {
    currentQuestion++;
    showQuestion();
}

// æœ€çµ‚çµæœè¡¨ç¤º
function showFinalResult() {
    document.getElementById('quizContent').style.display = 'none';
    document.getElementById('finalResult').style.display = 'block';
    document.getElementById('finalScore').textContent = 
        `${correctCount}/${filteredQuestions.length}`;
    updateDashboardStats();
}

// å±¥æ­´æ›´æ–°
function updateHistory() {
    try {
        let history = localStorage.getItem('isms_quiz_history');
        history = history ? JSON.parse(history) : {
            totalQuizzes: 0,
            totalQuestions: 0,
            totalCorrect: 0,
            quizHistory: [],
            wrongAnswers: []
        };
        
        const today = new Date().toISOString().split('T')[0];
        const dailyKey = `isms_daily_${today}`;
        let dailyProgress = localStorage.getItem(dailyKey);
        dailyProgress = dailyProgress ? JSON.parse(dailyProgress) : { completed: 0 };
        
        // 1å•è§£ãã”ã¨ã«ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å ´åˆ
        dailyProgress.completed = (dailyProgress.completed || 0) + 1;
        localStorage.setItem(dailyKey, JSON.stringify(dailyProgress));
        
        // ç·åˆå±¥æ­´ã®æ›´æ–°ã¯å®Œäº†æ™‚ã®ã¿ã«ã™ã‚‹ã‹ã€éƒ½åº¦ã«ã™ã‚‹ã‹ã¯è¨­è¨ˆæ¬¡ç¬¬ã§ã™ãŒã€
        // ã“ã“ã§ã¯å®‰å…¨ã®ãŸã‚ã€Œæ­£è§£æ•°ã€ãªã©ã¯éƒ½åº¦æ›´æ–°ã›ãšã€å®Œäº†æ™‚ã«ä¸€æ‹¬ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
        // ç¾çŠ¶ã®ãƒ­ã‚¸ãƒƒã‚¯ã ã¨ã€Œç­”ãˆåˆã‚ã›ã€ã®ãŸã³ã« history.totalCorrect ãŒå¢—ãˆã‚‹ã®ã§OKã§ã™ã€‚
        
        // ãƒ’ã‚¹ãƒˆãƒªãƒ¼é…åˆ—ã¸ã®è¿½åŠ ã¯ã€Œã‚¯ã‚¤ã‚ºå®Œäº†æ™‚ã€ã®ã¿ã«è¡Œã†ã‚ˆã†ä¿®æ­£æ¨å¥¨
        // ï¼ˆã“ã®é–¢æ•°ãŒ checkAnswer ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
        
        localStorage.setItem('isms_quiz_history', JSON.stringify(history));
    } catch(e) {
        console.log('Local Storage Error:', e);
    }
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆæ›´æ–°
function updateDashboardStats() {
    try {
        const history = JSON.parse(localStorage.getItem('isms_quiz_history') || '{"totalQuestions":0,"totalCorrect":0,"quizHistory":[]}');
        const today = new Date().toISOString().split('T')[0];
        const dailyKey = `isms_daily_${today}`;
        const dailyProgress = JSON.parse(localStorage.getItem(dailyKey) || '{"completed":0}');
        
        const goalTarget = 5;
        const completed = Math.min(dailyProgress.completed, goalTarget);
        const todayPercent = (completed / goalTarget) * 100;
        
        document.getElementById('todayGoal').textContent = `${goalTarget}å•ä¸­ ${completed}å•å®Œäº†`;
        document.getElementById('todayProgress').style.width = todayPercent + '%';
        
        const streak = getStreak();
        document.getElementById('streakDays').textContent = `${streak}æ—¥é€£ç¶š`;
        
        const overallRate = history.totalQuestions > 0
            ? Math.round((history.totalCorrect / history.totalQuestions) * 100)
            : 0;
        document.getElementById('overallRate').textContent = overallRate + '%';
        
        renderCharts();
    } catch(e) {
        console.log('Stats Error:', e);
    }
}

// ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—
function getStreak() {
    let streak = 0;
    let currentDate = new Date();
    
    // æœ€å¤§365æ—¥åˆ†ãƒã‚§ãƒƒã‚¯ãªã©ã®åˆ¶é™ã‚’è¨­ã‘ã‚‹ã¨å®‰å…¨
    for(let i=0; i<365; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const dailyKey = `isms_daily_${dateStr}`;
        const progress = localStorage.getItem(dailyKey);
        
        if (progress) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
        } else if (i === 0) {
            // ä»Šæ—¥ã®åˆ†ãŒã¾ã ãªãã¦ã‚‚ã€æ˜¨æ—¥ã‚„ã£ã¦ã‚Œã°ç¶™ç¶šæ‰±ã„ã«ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ãªã‚‰ã“ã“ã«è¨˜è¿°
            // å˜ç´”ãªãƒ­ã‚¸ãƒƒã‚¯ãªã‚‰ã“ã“ã§break
            currentDate.setDate(currentDate.getDate() - 1); // ä¸€æ—¦æ˜¨æ—¥ã‚’è¦‹ã¦ã¿ã‚‹
            continue;
        } else {
            break;
        }
    }
    return streak;
}

// ãƒãƒ£ãƒ¼ãƒˆæç”»
function renderCharts() {
    if (typeof Chart === 'undefined') {
        console.log('Chart.js is not loaded yet');
        return;
    }
    
    // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    const pChart = document.getElementById('progressChart');
    if(!pChart) return;

    const history = JSON.parse(localStorage.getItem('isms_quiz_history') || '{"quizHistory":[]}');
    const recentHistory = history.quizHistory.slice(-10);
    
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°ç ´æ£„
    if (pChart.chartInstance) {
        pChart.chartInstance.destroy();
    }
    
    const ctx = pChart.getContext('2d');
    pChart.chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: recentHistory.map((_, i) => `${i + 1}å›ç›®`),
            datasets: [{
                label: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰',
                data: recentHistory.map(h => h.percentage),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
    
    // ã‚«ãƒ†ã‚´ãƒªãƒãƒ£ãƒ¼ãƒˆ
    const cChart = document.getElementById('categoryChart');
    if(!cChart) return;

    if (cChart.chartInstance) {
        cChart.chartInstance.destroy();
    }
    
    const categoryStats = {};
    if(allQuestions.length > 0) {
        allQuestions.forEach(q => {
            if (!categoryStats[q.category]) {
                categoryStats[q.category] = { correct: 0, total: 0 };
            }
            categoryStats[q.category].total++;
        });
    }
    
    const ctx2 = cChart.getContext('2d');
    cChart.chartInstance = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: Object.keys(categoryStats),
            datasets: [{
                label: 'å•é¡Œæ•°', // ãƒ‡ãƒ¼ã‚¿æ§‹é€ çš„ã«ã€Œæ­£ç­”æ•°ã€ã‚’å‡ºã™ã«ã¯å±¥æ­´ã®è©³ç´°åˆ†æãŒå¿…è¦ãªãŸã‚ä¸€æ—¦å•é¡Œæ•°
                data: Object.values(categoryStats).map(s => s.total),
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
function showDashboard() {
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('quizContent').style.display = 'block';
    document.getElementById('finalResult').style.display = 'none';
    updateDashboardStats();
}

// ã‚¯ã‚¤ã‚ºå†è©¦è¡Œ
function retryQuiz() {
    startQuiz();
}

// CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportCSV() {
    let csv = 'Date,Score,Percentage\n';
    const history = JSON.parse(localStorage.getItem('isms_quiz_history') || '{"quizHistory":[]}');
    history.quizHistory.forEach(h => {
        csv += `${h.date},${h.percentage}%\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'isms_quiz_history.csv';
    link.click();
}

// Xï¼ˆTwitterï¼‰ã§å…±æœ‰
function shareOnX() {
    const history = JSON.parse(localStorage.getItem('isms_quiz_history') || '{"totalCorrect":0,"totalQuestions":0}');
    const rate = history.totalQuestions > 0
        ? Math.round((history.totalCorrect / history.totalQuestions) * 100)
        : 0;
    
    const text = `ğŸ¯ ISMSãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’é€²æ—\næ­£è§£ç‡: ${rate}%\næ­£è§£æ•°: ${history.totalCorrect}/${history.totalQuestions}\n#ISMS #æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}
</script>
</body>
</html>












